<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="geral/img/logo/simbolo.png" type="image/x-icon" />
  <link rel="stylesheet" href="geral/css/style.css" />
  <link rel="stylesheet" href="geral/css/media-query.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <title>Carrinho â€¢ Cyber X</title>
</head>

<body>
  <header class="header" style="height: 80px; justify-content: center;">
    <nav class="nav__subcontainer">
      <a href="index.html" class="nav__logo" style="margin-bottom: 15px;">
        <img src="geral/img/logo/logo branca.png" alt="Logo Preta" class="logo__light" />
        <img src="geral/img/logo/logo.png" alt="Logo Branca" class="logo__dark" />
      </a>
      <div class="search__btn">
        <label for="input-search" id="search-title">
          <i class="ri-search-line icon-search"></i>
        </label>
        <input type="text" name="search" id="input-search" placeholder="O que estÃ¡ buscando?" maxlength="30" />
      </div>
      <div class="nav__actions">
        <div class="login__page" id="login-container">
          <i id="login-icon" class="ri-login-box-line login__btn"></i>
        </div>
        <i class="ri-moon-line change-theme" id="theme-button"></i>
        <div class="cart__page">
          <a href="cart.html">
            <i class="ri-shopping-cart-line shop-btn"></i>
          </a>
          <span id="cart-badge" class="cart-badge">0</span>
        </div>
        <div class="nav__toggle" id="nav-toggle">
          <i class="ri-menu-5-line"></i>
        </div>
      </div>
    </nav>
  </header>


  <main class="cart__main">
    <section class="cart-container">
      <h1>Seu Carrinho</h1>
      <div id="cart-items"></div>
      <div class="cart-summary">
        <p>Total: <span id="cart-total">R$ 0,00</span></p>
        <button id="checkout-btn" class="button">Finalizar Compra</button>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__container">
      <!-- Logo + redes -->
      <div class="footer__column footer__logo">
        <a href="index.html"><img src="geral/img/logo/logo branca.png" alt="CyberX"
            class="footer__logo-img logo__light"></a>
        <a href="index.html"><img src="geral/img/logo/logo.png" alt="CyberX" class="footer__logo-img logo__dark"></a>
        <div class="footer__socials">
          <a href="#"><i class="ri-facebook-fill"></i></a>
          <a href="#"><i class="ri-instagram-fill"></i></a>
          <a href="#"><i class="ri-twitter-fill"></i></a>
          <a href="#"><i class="ri-youtube-fill"></i></a>
          <a href="#"><i class="ri-pinterest-fill"></i></a>
          <a href="#"><i class="ri-discord-fill"></i></a>
        </div>
      </div>

      <!-- Institucional -->
      <div class="footer__column">
        <h3>INSTITUCIONAL</h3>
        <ul>
          <li><a href="about.html">Sobre NÃ³s</a></li>
          <li><a href="howpay.html">Como Comprar</a></li>
          <li><a href="segurity.html">SeguranÃ§a</a></li>
          <li><a href="distatch.html">Envio</a></li>
          <li><a href="payment.html">Pagamento</a></li>
          <li><a href="warranty.html">Tempo de Garantia</a></li>
          <li><a href="trades.html">Trocas e DevoluÃ§Ãµes</a></li>
          <li><a href="contact.html">Fale Conosco</a></li>
        </ul>
      </div>

      <!-- Atendimento + pagamentos -->
      <div class="footer__column">
        <h3>ATENDIMENTO</h3>
        <p><i class="ri-phone-fill"></i> (61) XXXXX-XXXX</p>
        <p><i class="ri-mail-fill"></i> cyberx123@gmail.com</p>

        <h3>FORMAS DE PAGAMENTO</h3>
        <div class="footer__payments">
          <img src="geral/img/pagamentos/visa.png" alt="Visa">
          <img src="geral/img/pagamentos/mastercard.png" alt="Mastercard">
          <img src="geral/img/pagamentos/pix.png" alt="Pix">
          <img src="geral/img/pagamentos/amex.png" alt="Amex">
          <img src="geral/img/pagamentos/elo.png" alt="Elo">
          <img src="geral/img/pagamentos/boleto.png" alt="Boleto">
        </div>
      </div>
      <span class="footer__copy">
        Â© 2025 <a href="https://dev-vrmc-portfolio.netlify.app/" target="_blank" rel="noopener noreferrer">Victor
          Roger</a>. Todos os direitos reservados.
      </span>
    </div>
  </footer>
  <a href="#" class="scrollup" id="scroll-up">
    <i class="ri-arrow-up-line"></i>
  </a>

  <script type="module" src="geral/js/supabase.js"></script>
  <script type="module" src="geral/js/auth.js"></script>
  <script type="module" src="geral/js/ui.js"></script>
  <script type="module" src="geral/js/cart.js"></script>
  <script type="module" src="geral/js/products.js"></script>
  <script type="module" src="geral/js/main.js"></script>
  <script type="module">
    import { cart } from './geral/js/cart.js';
    import { authManager } from './geral/js/auth.js';
    import { orderManager } from './geral/js/order.js';

    // FunÃ§Ã£o para gerar a mensagem do WhatsApp (versÃ£o melhorada)
    function generateWhatsAppMessage(order, cartItems, userProfile) {
      const customerName = userProfile?.full_name || 'Cliente';

      let message = `ðŸ›’ *CONFIRMAÃ‡ÃƒO DE PEDIDO*\n\n`;
      message += `ðŸ‘¤ *Nome:* ${customerName}\n`;
      message += `ðŸ“¦ *Pedido NÂº:* ${order.id}\n\n`;

      message += `ðŸ§¾ *Itens do Pedido:*\n`;
      cartItems.forEach(item => {
        message += `â€¢ ${item.quantity}x _${item.name}_ â€” R$ ${(item.price * item.quantity).toFixed(2).replace('.', ',')}\n`;
      });

      message += `\nðŸ’° *Total:* R$ ${Number(order.total).toFixed(2).replace('.', ',')}\n`;
      message += `ðŸ“… *Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;
      message += `âœ… *Aguardando confirmaÃ§Ã£o do vendedor.*`;

      return message;
    }


    document.addEventListener('DOMContentLoaded', () => {
      // --- CÃ“DIGO RESTAURADO ---
      // Renderiza os itens do carrinho na pÃ¡gina
      cart.renderCartPage();

      const cartItemsContainer = document.getElementById('cart-items');

      // Evento para atualizar a quantidade
      cartItemsContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('cart-item-quantity')) {
          const id = parseInt(e.target.dataset.id, 10);
          const quantity = parseInt(e.target.value, 10);
          cart.updateQuantity(id, quantity);
        }
      });

      // Evento para remover um item
      cartItemsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('cart-item-remove')) {
          const id = parseInt(e.target.dataset.id, 10);
          cart.removeFromCart(id);
        }
      });
      // --- FIM DO CÃ“DIGO RESTAURADO ---


      const checkoutBtn = document.getElementById('checkout-btn');
      checkoutBtn.addEventListener('click', async () => {
        const user = await authManager.getCurrentUser();
        if (!user) {
          alert('VocÃª precisa estar logado para finalizar a compra.');
          window.location.href = 'login.html';
          return;
        }

        const cartItems = cart.getCart();
        if (cartItems.length === 0) {
          alert('Seu carrinho estÃ¡ vazio.');
          return;
        }

        const newOrder = await orderManager.createOrder(cartItems);

        if (newOrder && newOrder.id) {
          const userProfile = await authManager.fetchUserProfile();
          const storePhoneNumber = '5561992260378'; // substitua pelo nÃºmero real
          const message = generateWhatsAppMessage(newOrder, cartItems, userProfile);
          const whatsappUrl = `https://wa.me/${storePhoneNumber}?text=${encodeURIComponent(message)}`;

          window.open(whatsappUrl, '_blank');
          alert('Seu pedido foi registrado! Uma mensagem de confirmaÃ§Ã£o serÃ¡ aberta no WhatsApp para vocÃª enviar.');

          cart.clearCart();
          setTimeout(() => {
            window.location.href = 'account.html';
          }, 2000);

        } else {
          alert('Ocorreu um erro ao finalizar sua compra. Tente novamente.');
        }
      });
    });
  </script>
</body>

</html>